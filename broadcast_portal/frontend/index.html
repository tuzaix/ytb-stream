<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>直播发布管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" v-cloak>
        <!-- Navigation -->
        <nav v-if="token" class="bg-white shadow mb-6">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex">
                        <div class="flex-shrink-0 flex items-center">
                            <h1 class="text-xl font-bold text-gray-800">直播发布管理系统 V({{ maxAccounts }}个账号，每个账户{{ maxBroadcastTimes }}场直播/天 版本)</h1>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <span class="mr-4 text-gray-600 font-mono tabular-nums w-48 text-center inline-block">{{ currentTime }}</span>
                        <span class="mr-4 text-gray-600">管理员</span>
                        <button @click="logout" class="text-red-600 hover:text-red-800">退出登录</button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Login Screen -->
        <div v-if="!token" class="flex items-center justify-center min-h-screen">
            <div class="bg-white p-8 rounded shadow-md w-96">
                <h2 class="text-2xl font-bold mb-6 text-center">系统登录</h2>
                <form @submit.prevent="login">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">用户名</label>
                        <input v-model="loginForm.username" type="text" class="w-full border rounded p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2">密码</label>
                        <input v-model="loginForm.password" type="password" class="w-full border rounded p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">登录</button>
                    <p v-if="loginError" class="text-red-500 text-sm mt-2 text-center">{{ loginError }}</p>
                </form>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div v-else class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- System Status -->
            <div class="bg-white rounded-lg shadow p-6 mb-6" v-if="systemStatus">
                <h2 class="text-xl font-bold text-gray-800 mb-4">存储使用状态</h2>
                <div class="flex items-center">
                    <div class="flex-1 ml-4">
                        <div class="flex justify-between text-sm text-gray-600 mb-1">
                            <span>已用: {{ systemStatus.used_gb }} GB</span>
                            <span>总共: {{ systemStatus.total_gb }} GB</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div class="bg-blue-600 h-4 rounded-full transition-all duration-500" :style="{ width: systemStatus.percent + '%' }"></div>
                        </div>
                        <div class="text-right text-xs text-gray-500 mt-1">{{ systemStatus.percent }}%</div>
                    </div>
                </div>
            </div>

            <!-- Header Actions -->
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">账号列表</h2>
                <button @click="showCreateModal = true" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 flex items-center">
                    <span class="mr-2">+</span> 创建账号
                </button>
            </div>

            <!-- Accounts Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div v-for="account in accounts" :key="account.name" class="bg-white rounded-lg shadow p-6 relative">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-gray-900">{{ account.name }}</h3>
                        </div>
                        <div class="flex space-x-2">
                            <button @click="deleteAccount(account.name)" class="text-gray-400 hover:text-red-500" title="删除账号">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </div>

                    <!-- Status Badges -->
                    <div class="flex flex-wrap gap-2 mb-2">
                        <span :class="['px-2 py-1 text-xs rounded-full', account.auth_files_uploaded ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800']">
                            {{ account.auth_files_uploaded ? '已认证' : '未认证' }}
                        </span>
                        <span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800">
                            时长: {{ account.duration }}h
                        </span>
                        <span class="px-2 py-1 text-xs rounded-full bg-purple-100 text-purple-800">
                            已用: {{ formatDiskUsage(account.disk_usage_mb) }}
                        </span>
                        <span class="px-2 py-1 text-xs rounded-full bg-indigo-100 text-indigo-800">
                            视频数: {{ account.video_count }}
                        </span>
                    </div>
                    <!-- Broadcast Times -->
                    <div class="flex flex-wrap gap-2 mb-4">
                        <span v-for="t in account.broadcast_times" :key="t" class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">
                            {{ t }}
                        </span>
                    </div>

                    <div class="space-y-3">
                        <!-- FTP Info -->
                        <div class="bg-gray-50 p-3 rounded text-sm font-mono break-all border border-gray-200 space-y-1">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <span class="text-gray-500 w-20 flex-shrink-0 select-none">ftp ip：</span>
                                    <span class="text-gray-800">******</span>
                                </div>
                                <button @click="copyToClipboard(publicIp)" class="text-blue-500 hover:text-blue-700 text-xs px-2" title="复制IP">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                                </button>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <span class="text-gray-500 w-20 flex-shrink-0 select-none">ftp账号：</span>
                                    <span class="text-gray-800">******</span>
                                </div>
                                <button @click="copyToClipboard(account.ftp_username)" class="text-blue-500 hover:text-blue-700 text-xs px-2" title="复制账号">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                                </button>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <span class="text-gray-500 w-20 flex-shrink-0 select-none">ftp密码：</span>
                                    <span class="text-gray-800">******</span>
                                </div>
                                <button @click="copyToClipboard(account.ftp_password)" class="text-blue-500 hover:text-blue-700 text-xs px-2" title="复制密码">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                                </button>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="border-t pt-3 space-y-2">
                            <button @click="openAuthModal(account)" class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path></svg>
                                上传认证文件
                            </button>
                            <button @click="openTitleModal(account)" class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                配置直播文案
                            </button>
                            <button @click="openScheduleModal(account)" class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                配置直播时间
                            </button>
                            <button @click="openLogModal(account)" class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                直播记录
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modals -->
        
        <!-- Create Account Modal -->
        <div v-if="showCreateModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg w-96">
                <h3 class="text-lg font-bold mb-4">创建新账号</h3>
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-1">账号名称</label>
                    <input v-model="newAccount.name" type="text" class="w-full border p-2 rounded" placeholder="例如：LiveChannel01">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-1">账号描述</label>
                    <textarea v-model="newAccount.description" class="w-full border p-2 rounded" placeholder="可选：输入账号描述信息" rows="3"></textarea>
                </div>
                <div class="flex justify-end space-x-2">
                    <button @click="showCreateModal = false" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">取消</button>
                    <button @click="createAccount" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" :disabled="isSubmitting">
                        {{ isSubmitting ? '创建中...' : '创建' }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Upload Auth Modal -->
        <div v-if="showAuthModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg w-96">
                <h3 class="text-lg font-bold mb-4">上传认证文件</h3>
                <p class="text-sm text-gray-500 mb-4">当前账号：{{ currentAccount.name }}</p>
                
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-1">client_secret.json</label>
                    <input type="file" ref="clientSecretInput" accept=".json" class="w-full text-sm">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-1">token.json</label>
                    <input type="file" ref="tokenInput" accept=".json" class="w-full text-sm">
                </div>
                
                <div class="flex justify-end space-x-2">
                    <button @click="showAuthModal = false" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">取消</button>
                    <button @click="uploadAuthFiles" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" :disabled="isSubmitting">
                        {{ isSubmitting ? '上传中...' : '上传' }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Title Groups Modal -->
        <div v-if="showTitleModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg w-[600px] max-h-[80vh] flex flex-col">
                <h3 class="text-lg font-bold mb-4">配置直播文案</h3>
                <p class="text-sm text-gray-500 mb-4">当前账号：{{ currentAccount.name }}</p>

                <div class="flex-1 overflow-y-auto mb-4 space-y-4">
                    <div v-for="(item, index) in titleForm" :key="index" class="border p-4 rounded relative bg-gray-50">
                        <button @click="removeTitleItem(index)" class="absolute top-2 right-2 text-red-500 hover:text-red-700">x</button>
                        <div class="mb-2">
                            <label class="block text-xs font-bold text-gray-600">直播标题</label>
                            <input v-model="item.title" type="text" class="w-full border p-1 rounded text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600">直播描述</label>
                            <textarea v-model="item.description" rows="3" class="w-full border p-1 rounded text-sm"></textarea>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center border-t pt-4">
                    <button @click="addTitleItem" class="text-blue-500 hover:text-blue-700 font-bold">+ 添加文案组</button>
                    <div class="space-x-2">
                        <button @click="showTitleModal = false" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">取消</button>
                        <button @click="saveTitleGroups" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" :disabled="isSubmitting">保存</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Schedule Modal -->
        <div v-if="showScheduleModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg w-80">
                <h3 class="text-lg font-bold mb-4">配置直播时间 <span class="text-sm font-normal text-gray-500">(最多 {{ maxBroadcastTimes }} 个)</span></h3>
                
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-1">直播时长 (小时)</label>
                    <input v-model.number="scheduleForm.duration" type="number" step="0.5" min="0.5" max="3" class="w-full border p-2 rounded" placeholder="2.5">
                    <p class="text-xs text-gray-500 mt-1">最长支持 3 小时</p>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-bold mb-1">开始时间 (HH:MM)</label>
                    <div v-for="(t, idx) in scheduleForm.broadcast_times" :key="idx" class="flex items-center mb-2">
                        <input v-model="scheduleForm.broadcast_times[idx]" type="time" class="flex-1 border p-2 rounded mr-2">
                        <button @click="scheduleForm.broadcast_times.splice(idx, 1)" class="text-red-500 hover:text-red-700 font-bold" type="button">×</button>
                    </div>
                    <button v-if="scheduleForm.broadcast_times.length < maxBroadcastTimes" @click="addScheduleTime" class="text-sm text-blue-500 hover:text-blue-700" type="button">+ 添加时间</button>
                    <p v-else class="text-xs text-red-500 mt-2">已达到最大直播时间设置数量 ({{ maxBroadcastTimes }})</p>
                </div>
                <div class="flex justify-end space-x-2">
                    <button @click="showScheduleModal = false" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">取消</button>
                    <button @click="saveSchedule" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" :disabled="isSubmitting">保存</button>
                </div>
            </div>
        </div>

        <!-- Log Modal -->
        <div v-if="showLogModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg w-[800px] max-h-[80vh] flex flex-col">
                <h3 class="text-lg font-bold mb-4">直播记录 - {{ currentAccount?.name }}</h3>
                
                <div class="flex-1 overflow-y-auto mb-4 border rounded">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50">时间</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50">状态</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50">信息</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50">标题</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr v-for="(log, idx) in logList" :key="idx">
                                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">{{ log.timestamp }}</td>
                                <td class="px-4 py-2 whitespace-nowrap text-sm">
                                    <span :class="{
                                        'text-green-600 font-bold': log.status === 'SUCCESS' || log.status === 'STARTED' || log.status === 'MOCK_SUCCESS',
                                        'text-red-600 font-bold': log.status === 'ERROR' || log.status === 'FAILED',
                                        'text-gray-600': true
                                    }">{{ log.status }}</span>
                                </td>
                                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 max-w-xs truncate" :title="log.message">{{ log.message }}</td>
                                <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 max-w-xs truncate" :title="log.title">{{ log.title }}</td>
                            </tr>
                            <tr v-if="logList.length === 0">
                                <td colspan="4" class="px-4 py-8 text-center text-gray-500">暂无记录</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="flex justify-end">
                    <button @click="showLogModal = false" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">关闭</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, onMounted, computed } = Vue;

        createApp({
            setup() {
                const token = ref(localStorage.getItem('access_token') || '');
                const accounts = ref([]);
                const systemStatus = ref(null);
                const currentTime = ref('');
                const publicIp = ref('');
                const maxBroadcastTimes = ref(4);
                const maxAccounts = ref(10);
                
                const loginForm = ref({ username: '', password: '' });
                const loginError = ref('');
                
                const showCreateModal = ref(false);
                const newAccount = ref({ name: '', description: '' });
                
                const showAuthModal = ref(false);
                const clientSecretInput = ref(null);
                const tokenInput = ref(null);
                
                const showTitleModal = ref(false);
                const titleForm = ref([]);
                
                const showScheduleModal = ref(false);
                const scheduleForm = ref({ broadcast_times: [], duration: 2.5 });
                
                const showLogModal = ref(false);
                const logList = ref([]);
                
                const currentAccount = ref(null);
                const isSubmitting = ref(false);

                // --- API Helpers ---
                const api = axios.create({
                    baseURL: ''
                });

                api.interceptors.request.use(config => {
                    if (token.value) {
                        config.headers.Authorization = `Bearer ${token.value}`;
                    }
                    return config;
                });

                api.interceptors.response.use(
                    response => response,
                    error => {
                        if (error.response && error.response.status === 401) {
                            logout();
                        }
                        return Promise.reject(error);
                    }
                );

                // --- Methods ---

                const updateTime = () => {
                    const now = new Date();
                    currentTime.value = now.toLocaleString('zh-CN', { 
                        hour12: false, 
                        year: 'numeric', 
                        month: '2-digit', 
                        day: '2-digit', 
                        hour: '2-digit', 
                        minute: '2-digit', 
                        second: '2-digit' 
                    });
                };

                const login = async () => {
                    try {
                        const formData = new FormData();
                        formData.append('username', loginForm.value.username);
                        formData.append('password', loginForm.value.password);
                        
                        const res = await axios.post('/token', formData);
                        token.value = res.data.access_token;
                        localStorage.setItem('access_token', token.value);
                        loginError.value = '';
                        loadData();
                    } catch (err) {
                        loginError.value = '登录失败，请检查用户名和密码';
                    }
                };

                const logout = () => {
                    token.value = '';
                    localStorage.removeItem('access_token');
                };

                const loadData = async () => {
                    if (!token.value) return;
                    try {
                        const [accRes, statusRes, sysRes] = await Promise.all([
                            api.get('/accounts'),
                            api.get('/system_status'),
                            api.get('/system/info')
                        ]);
                        accounts.value = accRes.data;
                        systemStatus.value = statusRes.data;
                        publicIp.value = sysRes.data.public_ip;
                        maxBroadcastTimes.value = sysRes.data.max_broadcast_times || 4;
                        maxAccounts.value = sysRes.data.max_accounts || 10;
                    } catch (err) {
                        console.error("Failed to load data", err);
                    }
                };

                const createAccount = async () => {
                    if (!newAccount.value.name) return;
                    isSubmitting.value = true;
                    try {
                        await api.post('/accounts', newAccount.value);
                        showCreateModal.value = false;
                        newAccount.value = { name: '', description: '' };
                        loadData();
                    } catch (err) {
                        alert(err.response?.data?.detail || '创建失败');
                    } finally {
                        isSubmitting.value = false;
                    }
                };

                const deleteAccount = async (name) => {
                    if (!confirm(`确定要删除账号 ${name} 吗？此操作不可恢复。`)) return;
                    try {
                        await api.delete(`/accounts/${name}`);
                        loadData();
                    } catch (err) {
                        alert('删除失败');
                    }
                };

                const openAuthModal = (account) => {
                    currentAccount.value = account;
                    showAuthModal.value = true;
                };

                const uploadAuthFiles = async () => {
                    if (!clientSecretInput.value.files[0] || !tokenInput.value.files[0]) {
                        alert('请选择两个文件');
                        return;
                    }
                    isSubmitting.value = true;
                    try {
                        const formData = new FormData();
                        formData.append('client_secret', clientSecretInput.value.files[0]);
                        formData.append('token', tokenInput.value.files[0]);
                        
                        await api.post(`/accounts/${currentAccount.value.name}/auth`, formData);
                        showAuthModal.value = false;
                        loadData();
                    } catch (err) {
                        alert('上传失败');
                    } finally {
                        isSubmitting.value = false;
                    }
                };

                const openTitleModal = (account) => {
                    currentAccount.value = account;
                    // Deep copy
                    titleForm.value = JSON.parse(JSON.stringify(account.title_groups || []));
                    showTitleModal.value = true;
                };

                const addTitleItem = () => {
                    titleForm.value.push({ title: '', description: '' });
                };

                const removeTitleItem = (index) => {
                    titleForm.value.splice(index, 1);
                };

                const saveTitleGroups = async () => {
                    isSubmitting.value = true;
                    try {
                        await api.put(`/accounts/${currentAccount.value.name}/title_groups`, {
                            title_groups: titleForm.value
                        });
                        showTitleModal.value = false;
                        loadData();
                    } catch (err) {
                        alert('保存失败');
                    } finally {
                        isSubmitting.value = false;
                    }
                };

                const openScheduleModal = (account) => {
                    currentAccount.value = account;
                    scheduleForm.value = {
                        broadcast_times: [...(account.broadcast_times || [])],
                        duration: account.duration || 2.5
                    };
                    showScheduleModal.value = true;
                };

                const addScheduleTime = () => {
                    const times = scheduleForm.value.broadcast_times;
                    
                    // 寻找最后一个有效的时间格式 (HH:MM)
                    let lastTime = null;
                    // 从后往前找
                    for (let i = times.length - 1; i >= 0; i--) {
                        const t = times[i];
                        if (t && typeof t === 'string' && t.match(/^\d{1,2}:\d{2}/)) {
                            lastTime = t;
                            break;
                        }
                    }

                    // 如果找不到有效时间，默认添加 10:00
                    if (!lastTime) {
                        times.push('10:00');
                        return;
                    }

                    try {
                        const parts = lastTime.split(':');
                        const h = parseInt(parts[0], 10);
                        const m = parseInt(parts[1], 10);
                        
                        if (isNaN(h) || isNaN(m)) {
                            throw new Error('Invalid time format');
                        }

                        const lastMinutes = h * 60 + m;
                        
                        // 获取时长 (确保是数字)
                        let durationVal = parseFloat(scheduleForm.value.duration);
                        if (isNaN(durationVal) || durationVal <= 0) {
                            durationVal = 2.5; // Default fallback
                        }
                        
                        // 增加时长 + 30分钟缓冲
                        const durationMinutes = Math.ceil(durationVal * 60);
                        let nextMinutes = lastMinutes + durationMinutes + 30;
                        
                        // 归一化到一天内
                        nextMinutes = nextMinutes % (24 * 60);
                        
                        const nextH = Math.floor(nextMinutes / 60);
                        const nextM = nextMinutes % 60;
                        
                        const nextTimeStr = `${String(nextH).padStart(2, '0')}:${String(nextM).padStart(2, '0')}`;
                        times.push(nextTimeStr);
                    } catch (e) {
                        console.error("Error calculating next schedule time:", e);
                        times.push('10:00');
                    }
                };

                const saveSchedule = async () => {
                    // Check for duplicates
                    const times = scheduleForm.value.broadcast_times;
                    const uniqueTimes = new Set(times);
                    if (times.length !== uniqueTimes.size) {
                        alert('不允许设置相同的直播时间');
                        return;
                    }

                    if (times.length > maxBroadcastTimes.value) {
                        alert(`最多只能设置 ${maxBroadcastTimes.value} 个直播时间`);
                        return;
                    }

                    if (scheduleForm.value.duration > 3) {
                        alert('直播时长最长只能设置到 3 小时');
                        return;
                    }

                    // Check for interval
                    if (times.length > 1) {
                        const sortedTimes = [...times].sort();
                        const getMinutes = (t) => {
                            const [h, m] = t.split(':').map(Number);
                            return h * 60 + m;
                        };
                        const minutesList = sortedTimes.map(getMinutes);
                        const durationMinutes = scheduleForm.value.duration * 60;

                        for (let i = 0; i < minutesList.length; i++) {
                            const current = minutesList[i];
                            const nextIndex = (i + 1) % minutesList.length;
                            let next = minutesList[nextIndex];
                            
                            if (nextIndex === 0) {
                                next += 24 * 60;
                            }

                            if (next - current <= durationMinutes) {
                                alert(`直播时间间隔冲突：${sortedTimes[i]} 与下一场 ${sortedTimes[nextIndex]} 间隔过短（需大于 ${scheduleForm.value.duration} 小时）`);
                                return;
                            }
                        }
                    }

                    isSubmitting.value = true;
                    try {
                        await api.put(`/accounts/${currentAccount.value.name}/schedule`, scheduleForm.value);
                        showScheduleModal.value = false;
                        loadData();
                    } catch (err) {
                        if (err.response && err.response.data && err.response.data.detail) {
                            alert(err.response.data.detail);
                        } else {
                            alert('保存失败');
                        }
                    } finally {
                        isSubmitting.value = false;
                    }
                };
                
                const openLogModal = async (account) => {
                    currentAccount.value = account;
                    showLogModal.value = true;
                    logList.value = [];
                    try {
                        const res = await api.get(`/accounts/${account.name}/logs`);
                        logList.value = res.data;
                    } catch (err) {
                        console.error(err);
                    }
                };

                const copyToClipboard = (text) => {
                    navigator.clipboard.writeText(text).then(() => {
                        // Could show a toast
                    });
                };
                
                const formatDiskUsage = (mb) => {
                    if (mb > 1024) {
                        return (mb / 1024).toFixed(2) + ' GB';
                    }
                    return mb + ' MB';
                };

                // --- Lifecycle ---
                onMounted(() => {
                    setInterval(updateTime, 1000);
                    updateTime();
                    if (token.value) {
                        loadData();
                    }
                });

                return {
                    token,
                    accounts,
                    systemStatus,
                    currentTime,
                    publicIp,
                    loginForm,
                    loginError,
                    showCreateModal,
                    newAccount,
                    showAuthModal,
                    clientSecretInput,
                    tokenInput,
                    showTitleModal,
                    titleForm,
                    showScheduleModal,
                    scheduleForm,
                    showLogModal,
                    logList,
                    currentAccount,
                    isSubmitting,
                    
                    maxBroadcastTimes,
                    maxAccounts,
                    
                    login,
                    logout,
                    createAccount,
                    deleteAccount,
                    openAuthModal,
                    uploadAuthFiles,
                    openTitleModal,
                    addTitleItem,
                    removeTitleItem,
                    saveTitleGroups,
                    openScheduleModal,
                    addScheduleTime,
                    saveSchedule,
                    openLogModal,
                    copyToClipboard,
                    formatDiskUsage
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
